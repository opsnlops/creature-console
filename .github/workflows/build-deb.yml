name: Build Debian Packages

on:
  push:
    branches:
      - "*"

jobs:
  build:
    name: build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            container: debian:trixie-slim
          - arch: arm64
            runner: ubuntu-24.04-arm
            container: debian:trixie-slim
    env:
      SWIFT_VERSION: "6.2.1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            curl ca-certificates pkg-config clang \
            libicu-dev libxml2-dev libbsd-dev libcurl4-openssl-dev \
            libssl-dev libsqlite3-dev libzstd-dev libedit-dev zlib1g-dev \
            git cmake ninja-build python3 tar xz-utils build-essential \
            debhelper devscripts fakeroot

      - name: Install Swift via Swiftly
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz
          tar zxf swiftly-$(uname -m).tar.gz
          ./swiftly init --quiet-shell-followup
          source "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          swiftly install "${SWIFT_VERSION}"
          swift --version

      - name: Build Debian package
        run: |
          source "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          export DEB_BUILD_OPTIONS=nocheck
          SWIFT_BUILD_FLAGS="-c release --product creature-cli --static-swift-stdlib" \
            dpkg-buildpackage -us -uc -b

      - name: Collect deb artifact
        run: |
          mkdir -p artifacts
          mv ../creature-cli_*_${{ matrix.arch }}.deb artifacts/

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: creature-cli-${{ matrix.arch }}
          path: artifacts/creature-cli_*_${{ matrix.arch }}.deb
