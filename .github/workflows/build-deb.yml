name: Build Debian Packages

on:
  push:
    branches:
      - "*"

jobs:
  build:
    name: build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            container: debian:trixie-slim
          - arch: arm64
            runner: ubuntu-24.04-arm
            container: debian:trixie-slim
    env:
      SWIFT_VERSION: "6.2.1"
      STATIC_SDK_URL: https://download.swift.org/swift-6.2.1-release/static-sdk/swift-6.2.1-RELEASE/swift-6.2.1-RELEASE_static-linux-0.0.1.artifactbundle.tar.gz
      STATIC_SDK_SHA256: 08e1939a504e499ec871b36826569173103e4562769e12b9b8c2a50f098374ad

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            curl ca-certificates pkg-config clang \
            libicu-dev libxml2-dev libbsd-dev libcurl4-openssl-dev \
            libssl-dev libsqlite3-dev libzstd-dev libedit-dev zlib1g-dev \
            git cmake ninja-build python3 tar xz-utils build-essential \
            debhelper devscripts fakeroot

      - name: Install Swift via Swiftly
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz
          tar zxf swiftly-$(uname -m).tar.gz
          ./swiftly init --quiet-shell-followup
          source "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          swiftly install "${SWIFT_VERSION}"
          swift --version

      - name: Install static Linux SDK
        run: |
          source "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          swift sdk install "${STATIC_SDK_URL}" --checksum "${STATIC_SDK_SHA256}"
          swift sdk list

      - name: Build Debian package
        run: |
          source "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          export DEB_BUILD_OPTIONS=nocheck
          SWIFT_BUILD_FLAGS="-c release --product creature-cli --static-swift-stdlib --swift-sdk static-linux" \
            dpkg-buildpackage -us -uc -b

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: creature-cli-${{ matrix.arch }}
          path: creature-cli_*_${{ matrix.arch }}.deb
